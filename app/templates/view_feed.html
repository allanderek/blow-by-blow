{% extends "base.html" %}
{% block page_css %}
<style class="theme-agnostic">
#feed-moment-list{
    list-style: none;
    padding-left: 0;
}

.feed-moment{
    list-style-type: none;
}

.author-instructions{
    border: 5px solid red;
}

.author-update input,
.author-update textarea{
  padding: 10px;
  border: solid 5px #c9c9c9;
  transition: border 0.3s;
  width: 100%;
}

.author-update input:focus,
.author-update textarea:focus{
  border: solid 5px #6AC5AC;
}
</style>
<style class="theme-style wonderland">
.feed-moment{
    margin: 0.5em;
    border: 1px solid #6AC5AC;
}
.comment-time{
    color: #BBBB22;
}
.comment-text{
    color: #888888;
    padding-left: 1em;
}
</style>

<style class="theme-style wind-up">
.feed-moment{
    margin: 1em;
    border: 1px solid #6AC5AC;
    border-radius: 15px;
}
.comment-time{
    color: #AF2233;
    padding-left: 0.5em;
}
.comment-text{
    color: #115599;
    padding-left: 2em;
}
</style>


{% endblock %}
{% block content %}

<div id="feed-contents" class="main-column">


{% if secret is not none %}
<div id="send-viewers-link" class="author-instructions">
    <p>
    We do not need you to sign up for some kind of <i>account</i> before
    you can author a feed. However, we of course do not want anyone else
    to be able to author your feed. Hence if you look in your address
    bar you will see that you have a special URL with a
    <i>secret author number</i>. Don't give this out to anyone or they
    will be able to author your feed. Though of course if you actually
    wish to have multiple authors that would be how you do that.
    </p>
    <p>
    Presumably though you are writing this feed in order that people can
    view it. That's great. The <i>viewer</i> url for <b>this</b> feed is
    <a href="{{db_feed.viewers_link}}">{{db_feed.viewers_link}}</a>.
    Send people there, tweet, facebook, or otherwise share the viewer
    link so that people may read your event updates.
    </p>
    <p>
    In addition this means that you either do not want to navigate away
    from this page or keep the current URL safe somewhere. If you
    navigate away you might not be able to get back to this URL to
    author your feed. It may be in your browser history, but it's
    probably best just to avoid navigating away from here. You can of
    course open up additional browser windows or tabs.
    </p>
    <p>
    tl;dr:
        Do not send people the link in your address bar, that is your
        private link to author the feed. Send viewers here:
        <a href="{{db_feed.viewers_link}}">{{db_feed.viewers_link}}</a>
    </p>
<button id="dismiss-send-viewers-link" class="dismiss">Dismiss</button>
</div>
<div id="viewer-link" class="author-instructions">
   Viewers link: <a href="{{db_feed.viewers_link}}">{{db_feed.viewers_link}}</a>
</div>
{% endif %}

<div class="main-column page-title feed-title">
    {{db_feed.feed_title}}
</div>
<div class="main-column feed-description">
  {% if db_feed.feed_desc %}
  <p>
    {{db_feed.feed_desc}}
  </p>
  {% endif %}
</div>

{% if secret is not none %}
<div id="update-controls" class="main-column">
    <form id='update-feed' class="author-update" method="POST"
          action="{{ url_for('update_feed',
                             feed_no=db_feed.id,
                             secret=secret) }}">
        {{ update_feed_form.hidden_tag() }}
        {{ update_feed_form.title_text(placeholder="New Title") }}
        {{ update_feed_form.desc_text(placeholder="New Sticky Description") }}
        <button type="submit"
                class="update-feed-header-button"
                id="update-feed-header-button"
                name="update-feed-header-button">Update</button>
    </form>
</div><!-- End of update-controls -->
{% endif %}


{% if secret is not none %}
    <div id="commentate-area">
        <form id="make-comment" class="author-update"
              method="POST"
              action="{{ url_for('update_feed', feed_no=db_feed.id,
                                 secret=secret) }}">
                {{ update_feed_form.hidden_tag() }}
                {{ update_feed_form.comment_text(placeholder="New update comment:") }}
                <button type="submit"
                        class="commentate_button"
                        id="commentate_button"
                        name="commentate_button">Commentate</button>
            </form>
    </div>
{% endif %}

<div id="feedback-area">
  <form id="give-feedback" method="POST"
        action="{{ url_for('give_feedback') }}">
    {{ feedback_form.hidden_tag() }}
    {{ feedback_form.feedback_name(placeholder="Not required") }}
    {{ feedback_form.feedback_email(placeholder="Not required, but I won't be reply.") }}
    {{ feedback_form.feedback_text(placeholder="What do you wish to suggest/praise/complain about?") }}
    <button type="submit" class="feedback_submit_button"
            id="feedback_submit_button" name="feedback_submit_button">Provide Feedback</button>
  </form>
</div>


<div id="refreshing-feed">
Feed is refreshing
</div>
<a href="javascript:refresh_feed('{{ db_feed.id }}');">Refresh Feed</a>
<a id="toggle-feed-direction" href="javascript:toggle_feed_direction();">Toggle Feed Direction</a>

<ul id="feed-moment-list">
</ul>

</div><!-- End of div feed-contents -->
{% endblock %}
{% block page_scripts %}
<script>
var earliest_first = false;
function refresh_feed(feed_id) {
    $("#refreshing-feed").show();
    $.post('/grabmoments', {
        feed_id: feed_id
    }).done(function(translated) {
        $(".feed-title").text(translated['title']);
        $(".feed-description").text(translated['description']);
        $(".feed-moment").remove();
        var moments = translated['moments'];
        for (i = 0; i < moments.length; i++) {
          moment = moments[i];
	  moment_li = document.createElement('li');
	  moment_li.className = "feed-moment";
          time_div = document.createElement('div');
	  time_div.className = "comment-time";
          time_div.innerHTML = moment['time']
          text_div = document.createElement('div');
          text_div.className = "comment-text";
	  text_div.innerHTML = moment['content'];
          moment_li.appendChild(time_div);
	  moment_li.appendChild(text_div);
	  if (earliest_first){
              $("#feed-moment-list").append(moment_li);
          } else {
              $("#feed-moment-list").prepend(moment_li);
          }
	}
        $("#refreshing-feed").hide();
    }).fail(function() {
        $("#refreshing-feed").text("Error: Could not contact server.");
    });
    /* Now update the text which allows the user to toggle the feed direction */
    var toggle_link_text = "Show earliest first";
    if (earliest_first){
       toggle_link_text = "Show latest first";
    }
    $('#toggle-feed-direction').text(toggle_link_text);
}
function toggle_feed_direction(){
  earliest_first = !earliest_first;
  refresh_feed({{db_feed.id}});
}
jQuery(document).ready(function(){
    jQuery('#dismiss-send-viewers-link').live('click', function(event) {
       jQuery('#send-viewers-link').toggle('show');
       });
    refresh_feed({{db_feed.id}});
});

</script>
{% endblock %}
